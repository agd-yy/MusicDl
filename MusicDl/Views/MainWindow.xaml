<ui:FluentWindow
    x:Class="MusicDl.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:cnvts="clr-namespace:MusicDl.Converters"
    xmlns:controls="clr-namespace:MusicDl.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ext="clr-namespace:MusicDl.Extensions"
    xmlns:local="clr-namespace:MusicDl"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:model="clr-namespace:MusicDl.Models"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:MusicDl.ViewModels"
    Title="MusicDl"
    Width="600"
    Height="800"
    d:DataContext="{d:DesignInstance Type=vm:MainViewModel}"
    Activated="FluentWindow_Activated"
    Closing="FluentWindow_Closing"
    FontFamily="Microsoft Yahei"
    Icon="/Resources/CoverImage.png"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <ui:FluentWindow.Resources>
        <BitmapImage x:Key="DefaultCoverImage" UriSource="/Resources/CoverImage.png" />
        <Style BasedOn="{StaticResource {x:Type ui:Button}}" TargetType="ui:Button">
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style x:Key="SectionTitle" TargetType="TextBlock">
            <Setter Property="Margin" Value="0,12,0,6" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
        </Style>
        <Style x:Key="InfoLabel" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Margin" Value="0,2" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}" />
        </Style>
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="38" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--#region Title-->
        <ui:TitleBar Title="MusicDl" IsHitTestVisible="True">
            <ui:TitleBar.Icon>
                <ui:ImageIcon Source="{DynamicResource DefaultCoverImage}" />
            </ui:TitleBar.Icon>
            <!--#region Title Bar Menu-->
            <ui:TitleBar.Header>
                <StackPanel
                    Margin="0,0,120,0"
                    HorizontalAlignment="Right"
                    Orientation="Horizontal">
                    <ui:Button
                        Width="32"
                        Height="26"
                        Padding="0"
                        Appearance="Secondary"
                        BorderThickness="0"
                        Command="{Binding ShowCacheInfoCommand}"
                        Icon="{ui:SymbolIcon Info24}"
                        ToolTip="缓存信息" />
                    <ui:Button
                        Width="32"
                        Height="26"
                        Margin="4,0,0,0"
                        Padding="0"
                        Appearance="Secondary"
                        BorderThickness="0"
                        Command="{Binding ClearImageCacheCommand}"
                        Icon="{ui:SymbolIcon TextClearFormatting24}"
                        ToolTip="清理图片缓存" />
                </StackPanel>
            </ui:TitleBar.Header>
            <!--#endregion-->
        </ui:TitleBar>
        <!--#endregion-->

        <!--#region Search-->
        <Grid Grid.Row="1" Margin="5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <ui:TextBox
                x:Name="SearchTextBox"
                VerticalAlignment="Center"
                PlaceholderText="Please enter the music name."
                Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}">
                <ui:TextBox.InputBindings>
                    <KeyBinding Key="Enter" Command="{Binding SearchCommand}" />
                </ui:TextBox.InputBindings>
            </ui:TextBox>
            <ui:Button
                Grid.Column="1"
                Margin="8,0,0,0"
                Appearance="Primary"
                Command="{Binding SearchCommand}"
                Content="Search"
                FontWeight="Bold"
                Icon="{ui:SymbolIcon Search12}"
                IsEnabled="{Binding IsSearching, Converter={cnvts:InverseBooleanConverter}}" />
        </Grid>
        <!--#endregion-->

        <!--#region Options-->
        <Grid
            Grid.Row="2"
            Margin="5,0"
            VerticalAlignment="Center">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="100" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <ComboBox ItemsSource="{Binding LimitOptions}" SelectedItem="{Binding SelectedLimit}" />
            <ComboBox
                Grid.Column="1"
                DisplayMemberPath="Description"
                ItemsSource="{Binding Source={ext:EnumTupleDesc {x:Type model:ApiProvider}}}"
                SelectedValue="{Binding SelectedApiProvider}"
                SelectedValuePath="Value" />
            <ComboBox
                Grid.Column="2"
                DisplayMemberPath="Description"
                ItemsSource="{Binding Source={ext:EnumDesc {x:Type model:AudioQuality}}}"
                SelectedValue="{Binding SelectedAudioQuality}"
                SelectedValuePath="Value" />
            <ComboBox
                Grid.Column="3"
                DisplayMemberPath="Description"
                ItemsSource="{Binding Source={ext:EnumDesc {x:Type model:SaveType}}}"
                SelectedValue="{Binding SelectedSaveType}"
                SelectedValuePath="Value" />
        </Grid>

        <ui:TextBox
            Grid.Row="3"
            Margin="5,0"
            HorizontalAlignment="Stretch"
            Cursor="Hand"
            IsReadOnly="True"
            PlaceholderText="Save location"
            Text="{Binding SaveDirectoryPath, UpdateSourceTrigger=PropertyChanged}"
            ToolTip="{Binding SaveDirectoryPath}">
            <ui:TextBox.Icon>
                <ui:SymbolIcon Symbol="FolderOpen24" />
            </ui:TextBox.Icon>
            <ui:TextBox.InputBindings>
                <MouseBinding Command="{Binding SelectSaveDirectoryCommand}" MouseAction="LeftClick" />
            </ui:TextBox.InputBindings>
        </ui:TextBox>
        <!--#endregion-->

        <!--#region List-->
        <ListBox
            Grid.Row="4"
            Margin="8,0"
            HorizontalContentAlignment="Stretch"
            Background="Transparent"
            BorderThickness="0"
            ItemsSource="{Binding MusicDetails}"
            ScrollViewer.HorizontalScrollBarVisibility="Disabled">
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="Padding" Value="0,2" />
                    <Setter Property="Margin" Value="0,3" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <ContentPresenter
                                    Margin="{TemplateBinding Padding}"
                                    HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                    VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate DataType="model:MusicDetail">
                    <Border
                        Margin="0,4"
                        Padding="12"
                        Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="70" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!--  Cover Image (使用 OptimizedImage)  -->
                            <Border
                                Width="60"
                                Height="60"
                                Margin="0,0,8,0"
                                ClipToBounds="True"
                                CornerRadius="4">
                                <controls:OptimizedImage
                                    DefaultImage="{StaticResource DefaultCoverImage}"
                                    ImageUrl="{Binding CoverUrl}"
                                    Stretch="UniformToFill" />
                            </Border>

                            <!--  Music Details  -->
                            <StackPanel
                                Grid.Column="1"
                                Margin="4,0"
                                VerticalAlignment="Center">
                                <!--  Music Name  -->
                                <TextBlock
                                    FontSize="16"
                                    FontWeight="Medium"
                                    Text="{Binding Name}"
                                    TextTrimming="CharacterEllipsis" />

                                <!--  Artists  -->
                                <Grid Margin="0,4,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <ui:SymbolIcon
                                        VerticalAlignment="Center"
                                        Opacity="0.6"
                                        Symbol="Person24" />

                                    <ItemsControl
                                        Grid.Column="1"
                                        Margin="4,0,0,0"
                                        ItemsSource="{Binding Artist}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock
                                                    Margin="0,0,5,0"
                                                    FontSize="12"
                                                    Opacity="0.8"
                                                    Text="{Binding Name}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>

                                <!--  Album & Duration  -->
                                <Grid Margin="0,4,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <ui:SymbolIcon
                                        Grid.Column="0"
                                        VerticalAlignment="Center"
                                        Opacity="0.6"
                                        Symbol="Album24" />

                                    <TextBlock
                                        Grid.Column="1"
                                        Margin="4,0,0,0"
                                        FontSize="11"
                                        Opacity="0.7"
                                        Text="{Binding Album.Name}"
                                        TextTrimming="CharacterEllipsis" />

                                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                                        <ui:SymbolIcon
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Symbol="Clock24" />
                                        <TextBlock
                                            Margin="4,0,0,0"
                                            FontSize="11"
                                            Opacity="0.7"
                                            Text="{Binding Duration}" />
                                    </StackPanel>
                                </Grid>

                                <!--  Quality & Size  -->
                                <StackPanel Margin="0,4,0,0" Orientation="Horizontal">
                                    <Border
                                        Padding="6,2"
                                        Background="Black"
                                        CornerRadius="4">
                                        <TextBlock
                                            FontSize="10"
                                            Foreground="White"
                                            Text="{Binding AudioQuality, Converter={cnvts:AudioQualityConverter}}" />
                                    </Border>

                                    <TextBlock
                                        Margin="12,0,0,0"
                                        FontSize="11"
                                        Opacity="0.7"
                                        Text="{Binding Size, Converter={cnvts:FileSizeConverter}}" />

                                    <Border
                                        Margin="8,0,0,0"
                                        Padding="4,1"
                                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CornerRadius="2"
                                        Visibility="{Binding IsMember, Converter={cnvts:BooleanToVisibilityConverter}}">
                                        <TextBlock
                                            FontSize="10"
                                            FontWeight="SemiBold"
                                            Foreground="{DynamicResource SystemAccentColorDark1Brush}"
                                            Text="VIP" />
                                    </Border>
                                </StackPanel>
                            </StackPanel>

                            <!--  Action Buttons  -->
                            <StackPanel
                                Grid.Column="2"
                                VerticalAlignment="Center"
                                Orientation="Horizontal">
                                <ui:Button
                                    Appearance="Info"
                                    Command="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.ParseCommand}"
                                    CommandParameter="{Binding .}"
                                    Icon="{ui:SymbolIcon Symbol=AppsListDetail24}"
                                    ToolTip="Detail" />
                                <ui:Button
                                    Appearance="Info"
                                    Command="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.DownloadCommand}"
                                    CommandParameter="{Binding .}"
                                    Icon="{ui:SymbolIcon Symbol=ArrowDownload24}"
                                    ToolTip="Download" />
                                <ui:Button
                                    Appearance="Info"
                                    Command="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.AddCommand}"
                                    CommandParameter="{Binding .}"
                                    Icon="{ui:SymbolIcon Symbol=Add24}"
                                    ToolTip="Add to Playlist" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        <!--#endregion-->

        <!--#region Floating Playlist Button-->
        <ui:Button
            Grid.Row="4"
            Width="60"
            Height="60"
            Margin="20"
            HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Appearance="Primary"
            Command="{Binding TogglePlaylistCommand}"
            CornerRadius="30"
            Icon="{ui:SymbolIcon MusicNote224}"
            ToolTip="播放列表">
            <ui:Button.Effect>
                <DropShadowEffect
                    BlurRadius="10"
                    Direction="270"
                    Opacity="0.3"
                    ShadowDepth="2" />
            </ui:Button.Effect>
        </ui:Button>
        <!--#endregion-->

        <!--#region Music Detail Panel-->
        <!--  Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"  -->
        <Border
            Grid.Row="1"
            Grid.RowSpan="4"
            Margin="15"
            d:Visibility="Collapsed"
            Background="White"
            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="12"
            DataContext="{Binding SelectedMusicDetail}"
            Visibility="{Binding DataContext.IsMusicDetailVisible, RelativeSource={RelativeSource AncestorType=Window}, Converter={cnvts:BooleanToVisibilityConverter}}">
            <Border.Effect>
                <DropShadowEffect
                    BlurRadius="20"
                    Direction="270"
                    Opacity="0.4"
                    ShadowDepth="5" />
            </Border.Effect>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  Header  -->
                <Grid Grid.Row="0" Margin="20,20,20,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock
                        FontSize="22"
                        FontWeight="SemiBold"
                        Text="音乐详情" />
                    <ui:Button
                        Grid.Column="1"
                        Command="{Binding DataContext.CloseMusicDetailCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        Icon="{ui:SymbolIcon Dismiss24}"
                        ToolTip="关闭" />
                </Grid>

                <!--  Content  -->
                <ScrollViewer
                    Grid.Row="1"
                    Margin="20,0"
                    VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!--  Header with Cover and Basic Info  -->
                        <Grid Margin="0,0,0,20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="140" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!--  Cover Image (使用 OptimizedImage)  -->
                            <Border
                                Width="130"
                                Height="130"
                                ClipToBounds="True"
                                CornerRadius="8">
                                <Border.Effect>
                                    <DropShadowEffect
                                        BlurRadius="8"
                                        Direction="270"
                                        Opacity="0.3"
                                        ShadowDepth="3" />
                                </Border.Effect>
                                <controls:OptimizedImage
                                    DefaultImage="{StaticResource DefaultCoverImage}"
                                    ImageUrl="{Binding CoverUrl}"
                                    Stretch="UniformToFill" />
                                <!--<Image Stretch="UniformToFill">
                                    <Image.Style>
                                        <Style TargetType="Image">
                                            <Setter Property="Source" Value="{Binding CoverUrl}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding CoverUrl}" Value="{x:Null}">
                                                    <Setter Property="Source" Value="{StaticResource DefaultCoverImage}" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding CoverUrl}" Value="">
                                                    <Setter Property="Source" Value="{StaticResource DefaultCoverImage}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Image.Style>
                                </Image>-->
                            </Border>

                            <!--  Basic Info  -->
                            <StackPanel Grid.Column="1" Margin="20,0,0,0">
                                <TextBlock
                                    FontSize="22"
                                    FontWeight="SemiBold"
                                    Text="{Binding Name}"
                                    TextWrapping="Wrap" />

                                <!--  Duration  -->
                                <StackPanel Margin="0,12,0,0" Orientation="Horizontal">
                                    <ui:SymbolIcon
                                        VerticalAlignment="Center"
                                        Foreground="{DynamicResource SystemAccentColorBrush}"
                                        Symbol="Clock24" />
                                    <TextBlock
                                        Margin="8,0,0,0"
                                        VerticalAlignment="Center"
                                        FontSize="14"
                                        Text="{Binding Duration}" />
                                </StackPanel>

                                <!--  Quality & Size  -->
                                <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                                    <Border
                                        Padding="8,4"
                                        Background="{DynamicResource SystemAccentColorBrush}"
                                        CornerRadius="6">
                                        <TextBlock
                                            FontSize="12"
                                            FontWeight="SemiBold"
                                            Foreground="White"
                                            Text="{Binding AudioQuality, Converter={cnvts:AudioQualityConverter}}" />
                                    </Border>
                                    <TextBlock
                                        Margin="12,0,0,0"
                                        VerticalAlignment="Center"
                                        FontSize="14"
                                        Text="{Binding Size, Converter={cnvts:FileSizeConverter}}" />

                                    <!--  VIP Badge  -->
                                    <Border
                                        Margin="12,0,0,0"
                                        Padding="6,2"
                                        Background="{DynamicResource SystemAccentColorDark1Brush}"
                                        CornerRadius="4"
                                        Visibility="{Binding IsMember, Converter={cnvts:BooleanToVisibilityConverter}}">
                                        <TextBlock
                                            FontSize="12"
                                            FontWeight="SemiBold"
                                            Foreground="White"
                                            Text="VIP" />
                                    </Border>
                                </StackPanel>
                            </StackPanel>
                        </Grid>

                        <!--  Artists Section  -->
                        <StackPanel Margin="0,0,0,16">
                            <TextBlock Style="{StaticResource SectionTitle}" Text="艺术家" />
                            <ItemsControl ItemsSource="{Binding Artist}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            Margin="0,4"
                                            Padding="12,8"
                                            Background="{DynamicResource SubtleFillColorSecondaryBrush}"
                                            CornerRadius="6">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>
                                                <ui:SymbolIcon
                                                    VerticalAlignment="Center"
                                                    Foreground="{DynamicResource SystemAccentColorBrush}"
                                                    Symbol="Person24" />
                                                <TextBlock
                                                    Grid.Column="1"
                                                    Margin="10,0,0,0"
                                                    VerticalAlignment="Center"
                                                    FontSize="14"
                                                    Text="{Binding Name}" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!--  Album Section  -->
                        <StackPanel Margin="0,0,0,16">
                            <TextBlock Style="{StaticResource SectionTitle}" Text="专辑信息" />
                            <Border
                                Padding="12,10"
                                Background="{DynamicResource SubtleFillColorSecondaryBrush}"
                                CornerRadius="6">
                                <StackPanel>
                                    <Grid Margin="0,0,0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <ui:SymbolIcon
                                            VerticalAlignment="Center"
                                            Foreground="{DynamicResource SystemAccentColorBrush}"
                                            Symbol="Album24" />
                                        <TextBlock
                                            Grid.Column="1"
                                            Margin="10,0,0,0"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            FontWeight="Medium"
                                            Text="{Binding Album.Name}" />
                                    </Grid>
                                    <Grid Visibility="{Binding Album.PublishTime, Converter={cnvts:StringToVisibilityConverter}}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <ui:SymbolIcon
                                            VerticalAlignment="Center"
                                            Foreground="{DynamicResource SystemAccentColorBrush}"
                                            Symbol="CalendarLtr24" />
                                        <TextBlock
                                            Grid.Column="1"
                                            Margin="10,0,0,0"
                                            VerticalAlignment="Center"
                                            Style="{StaticResource InfoLabel}"
                                            Text="{Binding Album.PublishTime}" />
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!--  URL Section  -->
                        <StackPanel Margin="0,0,0,16" Visibility="{Binding Url, Converter={cnvts:StringToVisibilityConverter}}">
                            <TextBlock Style="{StaticResource SectionTitle}" Text="音乐链接" />
                            <ui:TextBox
                                IsReadOnly="True"
                                Text="{Binding Url, Mode=OneWay}"
                                TextWrapping="Wrap" />
                        </StackPanel>

                        <!--  Lyrics Section  -->
                        <StackPanel Visibility="{Binding Lyric, Converter={cnvts:StringToVisibilityConverter}}">
                            <TextBlock Style="{StaticResource SectionTitle}" Text="歌词" />
                            <Border
                                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8">
                                <ScrollViewer MaxHeight="250" VerticalScrollBarVisibility="Auto">
                                    <TextBlock
                                        Padding="16"
                                        FontSize="13"
                                        LineHeight="20"
                                        Text="{Binding Lyric}"
                                        TextWrapping="Wrap" />
                                </ScrollViewer>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>

                <!--  Action Buttons  -->
                <Grid Grid.Row="2" Margin="20,10,20,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <ui:Button
                        Grid.Column="1"
                        Margin="0,0,10,0"
                        Padding="16,10"
                        Appearance="Success"
                        Command="{Binding DataContext.AddCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding .}"
                        Content="添加到列表"
                        Icon="{ui:SymbolIcon Symbol=Add24}" />

                    <ui:Button
                        Grid.Column="2"
                        Padding="16,10"
                        Appearance="Primary"
                        Command="{Binding DataContext.DownloadCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding .}"
                        Content="立即下载"
                        Icon="{ui:SymbolIcon Symbol=ArrowDownload24}" />
                </Grid>
            </Grid>
        </Border>
        <!--#endregion-->

        <!--#region Playlist Panel-->
        <!--  Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"  -->
        <Border
            Grid.Row="1"
            Grid.RowSpan="4"
            Margin="10"
            d:Visibility="Collapsed"
            Background="White"
            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Visibility="{Binding IsPlaylistVisible, Converter={cnvts:BooleanToVisibilityConverter}}">
            <Border.Effect>
                <DropShadowEffect
                    BlurRadius="15"
                    Direction="270"
                    Opacity="0.3"
                    ShadowDepth="3" />
            </Border.Effect>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Header  -->
                <Grid Grid.Row="0" Margin="15,15,15,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock
                        FontSize="20"
                        FontWeight="SemiBold"
                        Text="播放列表" />
                    <ui:Button
                        Grid.Column="1"
                        Command="{Binding TogglePlaylistCommand}"
                        Icon="{ui:SymbolIcon Dismiss24}"
                        ToolTip="关闭" />
                </Grid>

                <!--  Action Buttons  -->
                <StackPanel
                    Grid.Row="1"
                    Margin="15,0,15,10"
                    Orientation="Horizontal">
                    <ui:Button
                        Appearance="Success"
                        Command="{Binding DownloadAllPlaylistCommand}"
                        Content="全部下载"
                        Icon="{ui:SymbolIcon ArrowDownload24}" />
                    <ui:Button
                        Margin="10,0,0,0"
                        Appearance="Caution"
                        Command="{Binding ClearPlaylistCommand}"
                        Content="清空列表"
                        Icon="{ui:SymbolIcon Delete24}" />
                    <!--<ui:Button
                        Margin="10,0,0,0"
                        Appearance="Secondary"
                        Command="{Binding ClearImageCacheCommand}"
                        Content="清理缓存"
                        Icon="{ui:SymbolIcon TextClearFormatting24}" />-->
                    <TextBlock
                        Margin="15,0,0,0"
                        VerticalAlignment="Center"
                        FontSize="14"
                        Opacity="0.7"
                        Text="{Binding Playlist.Count, StringFormat='共 {0} 首'}" />
                </StackPanel>

                <!--  Playlist Items  -->
                <ListBox
                    Grid.Row="2"
                    Margin="10,0,10,10"
                    HorizontalContentAlignment="Stretch"
                    Background="Transparent"
                    BorderThickness="0"
                    ItemsSource="{Binding Playlist}"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="Padding" Value="0,2" />
                            <Setter Property="Margin" Value="0,2" />
                            <Setter Property="Background" Value="Transparent" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <ContentPresenter
                                            Margin="{TemplateBinding Padding}"
                                            HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                            VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border
                                Margin="0,2"
                                Padding="10"
                                Background="{DynamicResource SubtleFillColorSecondaryBrush}"
                                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="6">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="50" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!--  Cover Image (播放列表中也可以使用 OptimizedImage)  -->
                                    <Border
                                        Width="40"
                                        Height="40"
                                        Margin="0,0,8,0"
                                        ClipToBounds="True"
                                        CornerRadius="4">
                                        <controls:OptimizedImage
                                            DefaultImage="{StaticResource DefaultCoverImage}"
                                            ImageUrl="{Binding CoverUrl}"
                                            Stretch="UniformToFill" />
                                        <!--<Image Stretch="UniformToFill">
                                            <Image.Style>
                                                <Style TargetType="Image">
                                                    <Setter Property="Source" Value="{Binding CoverUrl}" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding CoverUrl}" Value="{x:Null}">
                                                            <Setter Property="Source" Value="{StaticResource DefaultCoverImage}" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding CoverUrl}" Value="">
                                                            <Setter Property="Source" Value="{StaticResource DefaultCoverImage}" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Image.Style>
                                        </Image>-->
                                    </Border>

                                    <!--  Music Info  -->
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock
                                            FontSize="14"
                                            FontWeight="Medium"
                                            Text="{Binding Name}"
                                            TextTrimming="CharacterEllipsis" />
                                        <TextBlock
                                            FontSize="11"
                                            Opacity="0.7"
                                            Text="{Binding Artist[0].Name}"
                                            TextTrimming="CharacterEllipsis" />
                                    </StackPanel>

                                    <!--  Action Buttons  -->
                                    <StackPanel
                                        Grid.Column="2"
                                        VerticalAlignment="Center"
                                        Orientation="Horizontal">
                                        <ui:Button
                                            Appearance="Danger"
                                            Command="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.RemoveFromPlaylistCommand}"
                                            CommandParameter="{Binding .}"
                                            Icon="{ui:SymbolIcon Delete24}"
                                            ToolTip="从播放列表移除" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>
        <!--#endregion-->

        <!--#region ProcessBar-->
        <!--  Loading Indicator  -->
        <ui:ProgressRing
            Grid.Row="2"
            Grid.RowSpan="3"
            Width="50"
            Height="50"
            d:Visibility="Collapsed"
            IsIndeterminate="True"
            Visibility="{Binding IsSearching, Converter={cnvts:BooleanToVisibilityConverter}}" />

        <ui:SnackbarPresenter
            x:Name="MainSnackbar"
            Grid.Row="2"
            Grid.RowSpan="3"
            VerticalAlignment="Bottom" />
        <!--#endregion-->
    </Grid>
</ui:FluentWindow>